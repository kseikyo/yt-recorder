# v0.2 Finish & Ship — Defect Fixes + Docs + Release

> **Fixes 3 defects in completed work, ships remaining docs, releases v0.2.0.**
> Predecessor plans: `v0.2-master-execution.md`, `v0.2-revision-security-perf-quality.md`

---

## TL;DR

Verification found 3 bugs in "completed" work (safe_resolve gaps, ruff failures blocking CI,
unused playlist_failed counter) plus 3 remaining doc tasks (SECURITY.md, issue templates, README).
Content-hash dedup (W8.1) and self-hosting docs (W8.2) **deferred to v0.3** — YAGNI.
8 atomic tasks, then push.

## Context

### What's Done (W0–W7, 17/24 tasks)
- Security hardening, Protocols, TranscriptStatus, Registry v2, Clean command
- Playlist bool return, Test coverage (177 tests), Health command
- 15 unpushed commits on main, mypy --strict passes

### What's Broken
1. `pipeline.py:166, :268` — `directory / entry.file` without `safe_resolve` (path traversal)
2. 23 ruff errors — unused imports from find_chrome refactor + import sorting (blocks CI)
3. `SyncReport.playlist_failed` defined but never populated (dead field)

### What's Deferred to v0.3
- W8.1: Content-hash dedup — filename dedup already works, no real duplicates reported
- W8.2: SELF_HOSTING.md — references StorageBackend protocol (deferred in revision plan)
- W5.1: DOM inspection — needs live YouTube Studio session
- W7.1: StorageBackend protocol — no second backend exists

## Global Constraints (inherited)

- Python 3.9, `from __future__ import annotations` for `X | Y`
- `mypy --strict`, `ruff check`, `ruff format --check` pass after EVERY commit
- Domain layer: ZERO adapter imports
- Frozen dataclasses, no mutation
- Commits: concise, sacrifice grammar

---

## Execution Order

```
A1 → A2 (parallel with A3) → B1 + B2 (parallel) → B3 → C1 → C2
```

---

## Phase A — Fix Defects (3 tasks)

### A1: Fix ruff lint errors
> **Why first**: Blocks CI. Must pass before any push.

**What**:
1. Remove unused imports `platform`, `shutil` from `src/yt_recorder/adapters/youtube.py:5,7`
   (orphaned when `find_chrome` moved to `utils.py`)
2. Run `ruff check --fix src tests` to auto-fix 13 import sorting issues
3. Manually verify remaining 10 errors (if any) after auto-fix

**Must NOT**:
- Change any logic or behavior
- Remove imports that ARE used (only `platform` and `shutil` are unused in youtube.py)

**Acceptance**:
- `ruff check src tests` → 0 errors
- `ruff format --check src tests` → 0 errors
- `mypy --strict src` → still passes
- `pytest -q` → 177 passed

**Verify**: `ruff check src tests && ruff format --check src tests && mypy --strict src && pytest -q`

```
Wave: A, blocks: [A2, A3], blocked-by: []
Commit: "fix: remove orphaned imports, sort import blocks"
```

---

### A2: Apply safe_resolve to remaining path joins
> **Why**: 2 code paths still vulnerable to path traversal via crafted registry entries.

**What**:
1. `pipeline.py:166` — retry_failed upload path:
   ```python
   # Before:
   file_path = directory / entry.file
   # After:
   file_path = safe_resolve(directory, entry.file)
   ```
2. `pipeline.py:268` — fetch_transcripts transcript path:
   ```python
   # Before:
   transcript_path = directory / "transcripts" / Path(entry.file).with_suffix(".md")
   # After:
   safe_entry = safe_resolve(directory, entry.file)
   rel_entry = safe_entry.relative_to(directory.resolve())
   transcript_path = directory / "transcripts" / rel_entry.with_suffix(".md")
   transcript_path.parent.mkdir(parents=True, exist_ok=True)
   ```
   Note: We validate entry.file via safe_resolve, then derive the transcript
   path from the validated relative path. This prevents `../../etc/passwd.md`.

**Must NOT**:
- Change clean_synced (line 328) — already uses safe_resolve ✓
- Change from_directory paths (lines 52, 58) — these are constants, not user-derived
- Break existing tests

**Acceptance**:
- `grep -n 'directory / entry\.' src/yt_recorder/pipeline.py` → 0 results
- `grep -n 'safe_resolve' src/yt_recorder/pipeline.py` → 3 results (lines ~166, ~268, ~328)
- `pytest tests/test_pipeline.py -q` → all pass
- `mypy --strict src` → passes

**Verify**: `grep -c 'directory / entry\.' src/yt_recorder/pipeline.py` should print `0`

```
Wave: A, blocks: [], blocked-by: [A1]
Commit: "security: safe_resolve on all registry-derived paths"
```

---

### A3: Fix playlist_failed propagation
> **Why**: SyncReport.playlist_failed (models.py:138) is defined but never incremented.
> The bool return plumbing exists (raid captures it) but data never reaches pipeline.

**What**:

1. **raid.py** — change `upload()` return to include playlist failure count:
   ```python
   def upload(
       self, path: Path, title: str, playlist: str
   ) -> tuple[dict[str, UploadResult | None], int]:
       """Upload to all accounts.

       Returns:
           Tuple of (account results dict, playlist_failures count).
       """
       playlist_failures = 0
       ...
       if not playlist_ok:
           logger.warning(...)
           playlist_failures += 1
       ...
       return results, playlist_failures
   ```

2. **pipeline.py upload_new()** — unpack tuple, count failures:
   ```python
   # Line ~126, single_account mode:
   playlist_ok = adapter.assign_playlist(result.video_id, playlist)
   if not playlist_ok:
       playlist_failed += 1

   # Line ~128, raid mode:
   results, pf = self.raid.upload(path, title, playlist)
   playlist_failed += pf
   ```

   Add `playlist_failed=playlist_failed` to SyncReport construction (line ~197).

3. **cli.py upload command** — display if > 0:
   ```python
   if report.playlist_failed:
       click.echo(f"Playlist failures: {report.playlist_failed}")
   ```

4. **tests** — update test_raid.py mocks that call `raid.upload()` to unpack tuple.
   Add 1 test: raid.upload with playlist failure → returns (results, 1).

**Must NOT**:
- Change the Protocol (VideoUploader.assign_playlist already returns bool ✓)
- Change youtube.py (already returns bool ✓)
- Break existing upload flow for successful cases

**Acceptance**:
- `pytest tests/test_raid.py tests/test_pipeline.py tests/test_cli.py -q` → all pass
- `mypy --strict src` → passes
- In test_raid: mock playlist returning False → verify tuple[1] == 1
- In test_pipeline: verify SyncReport.playlist_failed > 0 when playlist fails

```
Wave: A, blocks: [], blocked-by: [A1]
Commit: "fix: propagate playlist failures to SyncReport + CLI output"
```

---

## Phase B — Ship Docs (3 tasks)

### B1: SECURITY.md (parallel with B2)
> **Was W9.1 in master plan.**

**What**: Create `SECURITY.md` at project root.

**Content outline**:
```markdown
# Security Policy

## Reporting Vulnerabilities
[GitHub private security advisory link — NOT personal email]

## What Data Leaves Your Machine
- YouTube API calls via browser session (upload, transcript)
- yt-dlp HTTP calls (transcript download)
- No telemetry, analytics, or phone-home

## Credential Storage
- storage_state.json: Playwright session cookies + localStorage
- cookies.txt: Netscape format for yt-dlp
- Permissions: 0o600 enforced on every write
- Location: ~/.config/yt-recorder/
- .gitignore'd automatically by setup command

## CDP Port Exposure During Setup
- Chrome DevTools Protocol port opened during `yt-recorder setup`
- Any local process can connect during login window
- Random port reduces scan risk but doesn't eliminate it
- Close Chrome immediately after login capture

## Path Traversal Protection
- Registry-derived paths validated via safe_resolve()
- Prevents crafted registry entries from accessing files outside base directory

## Log Sanitization
- No video IDs or account names at INFO level
- %-formatting prevents log injection attacks
```

**Must NOT**: Include personal email/PII. Use GitHub security advisories.

**Acceptance**:
- File exists at `./SECURITY.md`
- References all 4 security measures implemented (W0.1-W0.4)
- No PII or placeholder emails

```
Wave: B, blocks: [B3], blocked-by: [A1]
Commit: "docs: SECURITY.md with credential + path traversal + CDP docs"
```

---

### B2: Issue templates (parallel with B1)
> **Was W9.2 in master plan.**

**What**: Create structured GitHub issue templates.

**Files**:
- `.github/ISSUE_TEMPLATE/bug_report.yml` — structured form
  - Required: version, OS, steps to reproduce, expected vs actual
  - Optional: logs, config (redacted)
- `.github/ISSUE_TEMPLATE/feature_request.yml` — structured form
  - Required: use case description (NOT solution)
  - Optional: alternatives considered
- `.github/ISSUE_TEMPLATE/config.yml`
  - `blank_issues_enabled: false`

**Must NOT**:
- Create PR template (not accepting PRs in v0.2)
- Include fields that request credentials or PII

**Acceptance**:
- `ls .github/ISSUE_TEMPLATE/` → 3 files
- Bug template has required fields: version, OS, steps, expected/actual
- Feature template requires use case, not implementation
- Blank issues disabled
- `gh label list` or manual check: labels exist for bug/feature if desired

```
Wave: B, blocks: [B3], blocked-by: [A1]
Commit: "chore: issue templates, blank issues disabled"
```

---

### B3: README refresh
> **Was W9.3 in master plan.**

**What**: Update README.md to reflect v0.2 architecture and features.

**Additions**:
1. **Architecture section** — text diagram showing hexagonal layers + protocols
2. **TranscriptStatus** — document the 4 states and retry behavior
3. **Full pipeline** — `upload --keep → status → transcribe → clean` flow
4. **Clean command** — add to Commands section
5. **Health command** — add to Commands section
6. **"Issues welcome · PRs paused"** notice with brief rationale
7. **Link to SECURITY.md**
8. **Version badge** or note: v0.2.0

**Must NOT**:
- Reference StorageBackend (deferred)
- Reference content-hash dedup (deferred)
- Remove existing content that's still accurate

**Acceptance**:
- README mentions TranscriptStatus with all 4 states
- README has `clean` and `health` commands documented
- README has "PRs paused" notice
- README links to SECURITY.md
- `grep 'SECURITY.md' README.md` → match
- `grep -i 'transcript.*status' README.md` → match

```
Wave: B, blocks: [C1], blocked-by: [B1, B2]
Commit: "docs: README v0.2 — architecture, TranscriptStatus, clean/health cmds"
```

---

## Phase C — Release (2 tasks)

### C1: Version bump + CI alignment
> **Why**: pyproject.toml still says 0.1.0. CI missing ruff format check.

**What**:
1. `pyproject.toml:3` → `version = "0.2.0"`
2. CI `.github/workflows/ci.yml` lint job — add `ruff format --check`:
   ```yaml
   - run: uv run ruff check src tests
   - run: uv run ruff format --check src tests
   - run: uv run mypy --strict src
   ```

**Must NOT**: Change Python version, dependencies, or test config.

**Acceptance**:
- `grep 'version' pyproject.toml` → `"0.2.0"`
- CI lint job has 3 steps: ruff check, ruff format --check, mypy --strict
- `ruff check src tests && ruff format --check src tests && mypy --strict src && pytest -q` → all pass

```
Wave: C, blocks: [C2], blocked-by: [B3]
Commit: "chore: version 0.2.0 + align CI with pre-commit checks"
```

---

### C2: Push + verify
> **Final task. Not a code commit.**

**What**:
1. Run full validation suite locally:
   ```bash
   ruff check src tests && \
   ruff format --check src tests && \
   mypy --strict src && \
   pytest --cov -q
   ```
2. `git push origin main`
3. Check GitHub Actions: both `lint` and `test` jobs pass
4. Verify: `gh run list --limit 1` shows success

**Acceptance**:
- Local: 0 ruff errors, 0 mypy errors, 177+ tests pass
- Remote: CI green on both lint and test jobs
- `git status` → clean working tree, up to date with origin/main

```
Wave: C, blocks: [], blocked-by: [C1]
NOT a commit — operational task only.
```

---

## Deferred to v0.3 (rationale)

| Task | Why Deferred |
|------|-------------|
| W8.1 Content-hash dedup | YAGNI — filename dedup works, 0 real-world duplicate reports. Adds latency + registry complexity. |
| W8.2 SELF_HOSTING.md | References StorageBackend protocol which doesn't exist. Speculative without concrete code. |
| W5.1 DOM inspection | Needs live YouTube Studio session. Playlist selectors are stale but documented as such. |
| W7.1 StorageBackend protocol | Premature abstraction. No second backend exists. Extract when needed (~1h). |

## Success Criteria

- [x] `ruff check src tests` → 0 errors
- [x] `ruff format --check src tests` → 0 errors
- [x] `mypy --strict src` → 0 issues
- [x] `pytest --cov -q` → 177+ tests, 0 failures
- [x] `grep 'directory / entry\.' src/yt_recorder/pipeline.py` → 0 matches
- [x] SyncReport.playlist_failed populated in upload flow
- [x] SECURITY.md exists with all 4 security measures documented
- [x] Issue templates block blank issues
- [x] README documents TranscriptStatus, clean, health, PRs paused
- [x] pyproject.toml version = 0.2.0
- [ ] CI green on GitHub Actions after push
- [ ] No credential files or PII in any committed file

## Dependency Graph

```
A1 (ruff fix)
 ├── A2 (safe_resolve)
 ├── A3 (playlist_failed)
 ├── B1 (SECURITY.md) ──┐
 └── B2 (issue templates)├── B3 (README) → C1 (version+CI) → C2 (push)
```

A2 and A3 are parallel. B1 and B2 are parallel. Everything else sequential.
